<?php

/**
 * @file
 * The improved_multi_select module main php code
 */

/**
 * Implements hook_init().
 */
function improved_multi_select_init() {
  $is_enabled = FALSE;
  if (variable_get('improved_multi_select:isall', 0)) {
    $is_enabled = TRUE;
  }
  else {
    $arg = arg();
    if (isset($arg[0]) and !($arg[0] == 'system' or $arg[0] == 'public')) {
      if ($url = explode("\n", variable_get('improved_multi_select:url', ''))) {
        foreach ($url as $key => $value) {
          $value = trim($value);
          if (empty($value)) {
            unset($url[$value]);
          }
          else {
            $url[$key] = $value;
          }
        }
        if (count($url) > 0) {
          $cur_url = array();
          $cur_url[0] = implode('/', $arg);
          $cur_url[1] = trim(url($cur_url[0]), '/');
          if ($cur_url[0] == $cur_url[1]) {
            unset($cur_url[1]);
          }
          if (drupal_is_front_page()) {
            $cur_url[count($cur_url)] = '<front>';
          }
          foreach ($url as $key => $value) {
            if (!$is_enabled and array_search($value, $cur_url) !== FALSE) {
              $is_enabled = TRUE;
            }
          }
        }
      }
    }
  }
  if ($is_enabled) {
    drupal_add_css(drupal_get_path('module', 'improved_multi_select') . '/improved_multi_select.css');
    drupal_add_js(drupal_get_path('module', 'improved_multi_select') . '/improved_multi_select.js');
  }
}

/**
 * Implements hook_menu().
 */
function improved_multi_select_menu() {
  $items = array();
  $items['admin/config/user-interface/improved_multi_select'] = array(
    'title' => 'Improved Multi Select',
    'description' => 'Configure Improved Multi Select module.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('improved_multi_select_admin'),
    'access arguments' => array('administer site configuration'),
    'type' => MENU_NORMAL_ITEM,
  );
  return $items;
}

/**
 * Administration settings page
 */
function improved_multi_select_admin() {
  $form = array();
  $form['improved_multi_select:isall'] = array(
    '#type' => 'checkbox',
    '#title' => t('Replace all multi-select lists'),
    '#default_value' => variable_get('improved_multi_select:isall', 0),
  );
  $form['improved_multi_select:url'] = array(
    '#type' => 'textarea',
    '#title' => t('Replace multi-select lists on listed pages'),
    '#default_value' => variable_get('improved_multi_select:url', ''),
  );
  return system_settings_form($form);
}