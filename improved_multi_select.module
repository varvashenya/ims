<?php

/**
 * @file
 * Replace the default multi-select boxes with two pannel list and search.
 */

/**
 * Implements template_preprocess_page().
 */
function improved_multi_select_preprocess_page(&$variables) {
  $is_enabled = FALSE;
  $url = trim(\Drupal::config('improved_multi_select.settings')->get('url'));
  $selectors = array_filter(explode("\n", str_replace("\r", "\n", trim(\Drupal::config('improved_multi_select.settings')->get('selectors')))));

  if ($replace_all = \Drupal::config('improved_multi_select.settings')->get('isall')) {
    $is_enabled = TRUE;
  }
  else {
    if (($url && \Drupal::service('path.matcher')->matchPath(request_path(), $url)) || $selectors) {
      $is_enabled = TRUE;
    }
  }
  if ($is_enabled) {
    $selectors = improved_multi_select_load_selectors($replace_all, $selectors);
    // @todo: rewrite as a library, add jQuery dependency.
    $variables['#attached']['css'][drupal_get_path('module', 'improved_multi_select') . '/improved_multi_select.css'] = array();
    $variables['#attached']['js'][drupal_get_path('module', 'improved_multi_select') . '/improved_multi_select.js'] = array();
    $variables['#attached']['js'][] = array(
      'data' => array(
        'improved_multi_select' => array(
          'selectors' => $selectors,
          'filtertype' => \Drupal::config('improved_multi_select.settings')->get('filtertype'),
          'orderable' => \Drupal::config('improved_multi_select.settings')->get('orderable'),
          'groupresetfilter' => \Drupal::config('improved_multi_select.settings')->get('groupresetfilter'),
          'buttontext_add' => \Drupal::config('improved_multi_select.settings')->get('buttontext_add'),
          'buttontext_addall' => \Drupal::config('improved_multi_select.settings')->get('buttontext_addall'),
          'buttontext_del' => \Drupal::config('improved_multi_select.settings')->get('buttontext_del'),
          'buttontext_delall' => \Drupal::config('improved_multi_select.settings')->get('buttontext_delall'),
          'buttontext_moveup' => \Drupal::config('improved_multi_select.settings')->get('buttontext_moveup'),
          'buttontext_movedown' => \Drupal::config('improved_multi_select.settings')->get('buttontext_movedown'),
        ),
      ),
      'type' => 'setting',
    );
  }
}

/**
 * Return array of jQuery selectors from jQuery selectors or 'replace all' option.
 *
 * @param $replace_all
 *   Boolean indicating if all multiselects will be replaced.
 * @param $selectors
 *   Array with jQuery selectors.
 *
 * @return
 *   Array with jQuery selectors.
 */
function improved_multi_select_load_selectors($replace_all, $selectors) {
  $output = array();
  if (!empty($selectors) and !$replace_all) {
    foreach ($selectors as $selector) {
      $output[] = $selector;
    }
  }
  else {
    $output = array('select[multiple]');
  }
  return $output;
}
